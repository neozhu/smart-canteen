# 训练参数优化说明

## 🎯 优化目标
提高模型检测质量，从当前的 0.7% 最高置信度提升到 50%+ 的生产级别。

## 📊 优化的训练参数

### 1. 基础训练参数
- **训练轮次 (epochs)**: `50 → 150`
  - 更多轮次让模型充分学习特征
  - 配合 patience=50 避免过拟合
  
- **批次大小 (batch_size)**: `16 → 8`
  - 适应小数据集（120张）
  - 更稳定的梯度更新
  - 减少内存占用

### 2. 优化器和学习率
- **优化器**: `Adam → AdamW`
  - AdamW 解耦权重衰减，泛化能力更强
  
- **初始学习率 (lr0)**: `0.01 → 0.001`
  - 降低初始学习率，避免震荡
  - 更稳定的训练过程
  
- **最终学习率 (lrf)**: `0.01 → 0.0001`
  - 更精细的参数调整
  
- **余弦学习率 (cos_lr)**: `False → True`
  - 平滑的学习率衰减
  - 避免训练后期学习率过大

- **预热轮次 (warmup_epochs)**: `3.0 → 5.0`
  - 更长的预热期，稳定训练开始

### 3. 早停和收敛
- **耐心值 (patience)**: `10 → 50`
  - 给模型更多机会找到最优解
  - 对于小数据集，需要更多轮次才能收敛

- **关闭 Mosaic (close_mosaic)**: `10 → 15`
  - 最后15个epoch使用正常图片训练
  - 提高最终检测精度

### 4. 数据增强 (关键优化)

#### 颜色增强
- **色调变化 (hsv_h)**: `0.015 → 0.03`
- **饱和度变化 (hsv_s)**: `0.7 → 0.8`
- **亮度变化 (hsv_v)**: `0.4 → 0.5`
- **目的**: 适应不同光照条件

#### 几何增强
- **旋转 (degrees)**: `0.0 → 15.0`
  - 模拟物品的不同摆放角度
  
- **平移 (translate)**: `0.1 → 0.2`
  - 增加位置多样性
  
- **缩放 (scale)**: `0.5 → 0.7`
  - 模拟不同距离的物品
  
- **剪切 (shear)**: `0.0 → 5.0`
  - 增加形变容忍度
  
- **透视变换 (perspective)**: `0.0 → 0.0003`
  - 模拟不同视角

#### 混合增强
- **水平翻转 (fliplr)**: `0.5` (保持)
  - 50%概率水平翻转
  
- **垂直翻转 (flipud)**: `0.0` (保持)
  - 食物不适合垂直翻转
  
- **Mosaic**: `1.0` (保持)
  - 4张图片拼接，增加场景多样性
  
- **Mixup**: `0.0 → 0.1`
  - 10%概率混合两张图片
  - 提高泛化能力
  
- **Copy-Paste**: `0.0 → 0.1`
  - 10%概率复制粘贴物体
  - 增加样本多样性

## 📈 预期效果

### 训练时间
- **之前**: ~10-15分钟 (50 epochs)
- **现在**: ~30-45分钟 (150 epochs)

### 模型质量
- **当前**: 最高置信度 0.7%
- **目标**: 最高置信度 > 50%
- **生产阈值**: 25%

### 收敛指标
观察训练日志中的指标：
- `mAP50` (主要指标): 目标 > 0.8
- `Precision`: 目标 > 0.7
- `Recall`: 目标 > 0.7

## 🚀 如何训练

1. 访问标注页面：http://localhost:3000/annotate
2. 点击"🚀 开始训练模型"
3. 训练将自动使用优化后的参数（150 epochs）
4. 等待约30-45分钟完成训练
5. 训练完成后模型会自动加载

## 📝 训练日志解读

训练过程中会看到：
```
Epoch 1/150: 100%|██████████| 15/15 [00:20<00:00,  1.33s/it]
               Class     Images  Instances      Box(P)      Box(R)    mAP50   mAP50-95
                 all        120        120       0.523       0.487    0.445      0.256

Epoch 50/150: ...
               Class     Images  Instances      Box(P)      Box(R)    mAP50   mAP50-95
                 all        120        120       0.891       0.856    0.903      0.612

Epoch 150/150: ...
               Class     Images  Instances      Box(P)      Box(R)    mAP50   mAP50-95
                 all        120        120       0.932       0.915    0.951      0.687
```

重点关注：
- **mAP50**: 主要评价指标，> 0.8 即为优秀
- **Box(P)**: 精确率，越高越好
- **Box(R)**: 召回率，越高越好

## ⚠️ 注意事项

1. **CPU训练**: 当前使用CPU，训练较慢但稳定
2. **内存占用**: 批次大小降为8，避免内存不足
3. **数据量**: 120张样本是最低要求，建议增加到200+张
4. **类别平衡**: 当前6个类别各20张，分布均衡✅

## 🔍 后续优化建议

如果训练150轮后模型仍不理想：

1. **增加数据量**: 每个类别增加到30-50张
2. **数据多样性**: 
   - 不同光照（明亮、昏暗）
   - 不同角度（俯视、侧视）
   - 不同背景（木桌、白桌、深色桌）
3. **增加训练轮次**: 尝试200-300 epochs
4. **调整数据增强**: 根据实际效果微调参数
5. **GPU加速**: 如有GPU可设置 `device='cuda'`

## 📊 与之前的对比

| 参数 | 之前 | 优化后 | 提升 |
|------|------|--------|------|
| Epochs | 50 | 150 | +200% |
| Batch Size | 16 | 8 | -50% (更稳定) |
| Learning Rate | 0.01 | 0.001 | -90% (更稳定) |
| Patience | 10 | 50 | +400% |
| Optimizer | Adam | AdamW | 更好泛化 |
| Cosine LR | ❌ | ✅ | 平滑衰减 |
| Rotation Aug | 0° | ±15° | ✅ |
| Mixup | ❌ | 10% | ✅ |
| Copy-Paste | ❌ | 10% | ✅ |

---

**更新时间**: 2025-11-30
**预期训练时间**: 30-45分钟 (CPU)
**目标mAP50**: > 0.8
